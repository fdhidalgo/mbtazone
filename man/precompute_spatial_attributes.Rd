% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/gis_operations.R
\name{precompute_spatial_attributes}
\alias{precompute_spatial_attributes}
\title{Pre-compute Spatial Attributes for Simulation Workflows}
\usage{
precompute_spatial_attributes(
  parcels,
  station_areas = NULL,
  density_deductions = NULL,
  verbose = TRUE
)
}
\arguments{
\item{parcels}{An sf object containing parcel data (from
\code{\link{load_municipality}}). Must be in EPSG:26986 projection.}

\item{station_areas}{Optional sf object with transit station buffers (from
\code{\link{load_transit_stations}}). If provided, calculates station area
overlap for each parcel.}

\item{density_deductions}{Optional sf object with density deduction polygons
(from \code{\link{load_density_deductions}}). If provided, calculates
deduction area for each parcel.}

\item{verbose}{Logical indicating whether to print progress messages (default: TRUE)}
}
\value{
The input parcels sf object with additional pre-computed columns:
\describe{
\item{station_area_sf}{Numeric, area of parcel within station buffers
(square feet). 0 if no station overlap. Only added if station_areas provided.}
\item{station_area_pct}{Numeric, percentage of parcel within station buffers
(0 to 1). Only added if station_areas provided.}
\item{in_station_area}{Logical, TRUE if parcel has any station area overlap.
Only added if station_areas provided.}
\item{density_deduction_area}{Numeric, area of parcel within density
deduction zones (square feet). 0 if no deduction overlap. Only added if
density_deductions provided.}
}

The returned object has attribute \code{spatial_attributes_precomputed = TRUE}
and \code{precomputation_date} for tracking.
}
\description{
Pre-compute all spatial relationships between parcels and GIS layers to enable
high-performance batch simulation. This function calculates expensive spatial
intersections once, allowing thousands of capacity calculations to run using
only fast arithmetic operations.
}
\details{
\strong{Performance Benefits:}

This function enables ~1000x performance improvement for batch simulation
scenarios. By separating one-time spatial computations from iterative arithmetic
calculations, you can evaluate thousands of zoning scenarios efficiently:

\itemize{
\item \strong{Without pre-computation:} 10,000 simulations × 30 sec = 83 hours
\item \strong{With pre-computation:} 1× 30 sec + 10,000× 0.03 sec = 5 minutes
}

\strong{Typical Workflow:}

\preformatted{
# Setup phase (once per municipality)
parcels <- load_municipality("maynard.zip")
stations <- load_transit_stations()
deductions <- load_density_deductions()

parcels_enriched <- precompute_spatial_attributes(
  parcels,
  station_areas = stations,
  density_deductions = deductions
)

# Save for reuse
saveRDS(parcels_enriched, "maynard_enriched.rds")

# Simulation phase (1000s of iterations)
parcels <- readRDS("maynard_enriched.rds")  # Fast load

results <- lapply(1:10000, function(i) {
  zoning <- generate_random_zoning(...)

  capacity <- calculate_district_capacity(
    parcels,
    zoning,
    precomputed = TRUE  # Skip spatial operations
  )

  evaluate_compliance(capacity, ..., precomputed = TRUE)
})
}

\strong{Computation Details:}

\emph{Station Area Overlap:}
Uses \code{\link{calculate_station_intersection}} to compute spatial intersection
between each parcel and transit station buffers. Adds percentage and boolean
columns for easy filtering.

\emph{Density Deduction Area:}
Calculates per-parcel intersection with the gross density denominator deduction
layer. This replaces the district-level intersection normally done in
\code{\link{evaluate_compliance}}.
}
\section{NA Handling}{

\itemize{
\item Parcels outside station areas get \code{station_area_sf = 0} (not NA)
\item Parcels outside deduction zones get \code{density_deduction_area = 0} (not NA)
\item Invalid geometries are repaired with \code{sf::st_make_valid()}
}
}

\examples{
\dontrun{
# Load municipality data
parcels <- load_municipality(
  "inst/extdata/parcels/174_MAYNARD_basic.zip",
  community_name = "Maynard"
)

# Load GIS layers
stations <- load_transit_stations()
deductions <- load_density_deductions()

# Pre-compute spatial attributes
parcels_enriched <- precompute_spatial_attributes(
  parcels,
  station_areas = stations,
  density_deductions = deductions
)

# Check new columns
names(parcels_enriched)
# Includes: station_area_sf, station_area_pct, in_station_area,
#           density_deduction_area

# Save for simulation
saveRDS(parcels_enriched, "maynard_enriched.rds")

# Later: Load and use with precomputed = TRUE
parcels <- readRDS("maynard_enriched.rds")
zoning <- extract_zoning_parameters("model.xlsx", district = 1)

capacity <- calculate_district_capacity(
  parcels,
  zoning,
  precomputed = TRUE
)
}

}
\seealso{
\code{\link{calculate_district_capacity}},
\code{\link{evaluate_compliance}},
\code{\link{calculate_station_intersection}},
\code{\link{calculate_density_denominator}}
}
